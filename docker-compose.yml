x-common-variables: &common-variables
  PROJECT_NAME: ${PROJECT_NAME:-effective-mobile-app}
  NGINX_PORT: ${NGINX_PORT:-80}

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-effective-mobile-app}-backend
    hostname: backend
    restart: unless-stopped
    expose:
      - "8080"
    networks:
      - app-network
    environment:
      - PYTHONUNBUFFERED=1
    shm_size: '64mb'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-effective-mobile-app}-nginx
    hostname: nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

networks:
  app-network:
    name: ${PROJECT_NAME:-effective-mobile-app}-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24